
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nollstead Studio BTAudio – Custom Flasher</title>
  <!-- Load esptool-js (bundle) from CDN -->
  https://unpkg.com/esptool-js/bundle.js</script>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; max-width: 780px; margin: 48px auto; padding: 20px; background:#121212; color:#eaeaea; line-height:1.6; }
    h1 { margin:0 0 8px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin:16px 0; }
    button { background:#4CAF50; color:#fff; border:none; padding:12px 18px; border-radius:10px; font-weight:600; cursor:pointer; }
    button:hover { background:#43a047; }
    .panel { background:#1e1e1e; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:20px; margin:18px 0; }
    textarea { width:100%; height:220px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background:#0f0f0f; color:#cfe8ff; padding:10px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .muted { color:#bbb; }
  </style>
</head>
<body>
  <h1>BTAudio – Custom Web Flasher</h1>
  <p class="muted">Version 0.0.1 • Board: SparkFun ESP32 Thing Plus WROOM</p>

  <div class="panel">
    <div class="row">
      <button id="connectBtn">1) Connect</button>
      <button id="flashBtn" disabled>2) Flash UTAudio.bin</button>
      <button id="resetBtn" disabled>3) Reset</button>
    </div>
    <p class="muted">If the board doesn’t auto‑reboot, click Reset or press the physical <strong>RESET</strong> (EN) button.</p>
  </div>

  <div class="panel">
    <h3>Log</h3>
    <textarea id="log" readonly></textarea>
  </div>

<script>
(() => {
  const logEl = document.getElementById('log');
  const connectBtn = document.getElementById('connectBtn');
  const flashBtn   = document.getElementById('flashBtn');
  const resetBtn   = document.getElementById('resetBtn');

  let port = null;
  let transport = null;   // esptool-js transport
  let loader = null;      // esptool-js ESPLoader
  let baud = 460800;      // you can try 921600; some bridges/OSes are happier at 460800

  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    logEl.value += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Minimal terminal wrapper for esptool-js
  const espTerminal = {
    clean()    { logEl.value = ""; },
    writeLine(s){ log(s); },
    write(s)    { log(s); }
  };

  // Post-flash reset sequence via WebSerial signals:
  // Pulse EN low/high with GPIO0 (DTR) high, so the app boots normally.
  async function hardResetToApp() {
    if (!port) return;
    try {
      // Ensure GPIO0 (BOOT) is HIGH (normal boot)
      await port.setSignals({ dataTerminalReady: false });   // DTR = false
      // Pulse EN (RESET) LOW then HIGH via RTS
      await port.setSignals({ requestToSend: true  });       // RTS = true  => EN low
      await new Promise(r => setTimeout(r, 100));            // 100 ms
      await port.setSignals({ requestToSend: false });       // RTS = false => EN high
      log("Issued RTS/DTR reset (normal boot).");
    } catch (e) {
      log("Reset sequence failed: " + e.message);
    }
  }

  connectBtn.onclick = async () => {
    try {
      // Request a serial port and open it
      port = await navigator.serial.requestPort({});
      await port.open({ baudRate: baud });
      log(`Port opened @ ${baud} baud.`);

      // Create esptool-js transport & loader (from CDN bundle)
      // NOTE: ESPLoader & Transport classes are exposed by the bundle.
      transport = new Transport(port);
      loader = new ESPLoader(transport, baud, espTerminal);

      // Connect to chip
      await loader.connect();
      const chip = await loader.chip;
      log(`Connected to chip: ${chip}`);

      flashBtn.disabled = false;
      resetBtn.disabled = false;
    } catch (e) {
      log("Connect failed: " + e.message);
    }
  };

  flashBtn.onclick = async () => {
    try {
      // Fetch merged image
      const url = "webflash/UTAudio.bin";
      log("Downloading " + url + " …");
      const resp = await fetch(url, { cache: "no-cache" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const buf = new Uint8Array(await resp.arrayBuffer());
      log(`Image size: ${buf.length} bytes`);

      // Optional: erase (comment out to skip full erase for speed)
      log("Erasing…");
      await loader.eraseFlash();

      // Write at offset 0x0 (merged image)
      log("Writing flash @ 0x000000 … this may take ~30–90s for ~1MB images.");
      await loader.writeFlash(0x000000, buf);

      log("Flash complete. Wrapping up…");
      await hardResetToApp();   // try to auto‑reboot

      log("Done.");
    } catch (e) {
      log("Flash failed: " + e.message);
    }
  };

  resetBtn.onclick = async () => { await hardResetToApp(); };
})();
</script>
</body>
</html>
