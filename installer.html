
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nollstead Studio BTAudio – Custom Flasher</title>

  <!-- 1) Load esptool-js bundle BEFORE your inline script -->
  <script src="https://unpkg.com/esptool-js@0.8.2/bundle.js"></script>
  <!-- You can pin another recent version if you prefer -->
  <style>
    /* … your existing styles … */
  </style>
</head>
<body>
  <!-- … your existing HTML … -->

<script>
(() => {
  const logEl = document.getElementById('log');
  const connectBtn = document.getElementById('connectBtn');
  const flashBtn   = document.getElementById('flashBtn');
  const resetBtn   = document.getElementById('resetBtn');

  let port = null;
  let transport = null;   // esptool-js transport
  let loader = null;      // esptool-js ESPLoader
  let baud = 460800;

  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    logEl.value += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  const espTerminal = {
    clean()     { logEl.value = ""; },
    writeLine(s){ log(s); },
    write(s)    { log(s); }
  };

  async function hardResetToApp() {
    if (!port) return;
    try {
      await port.setSignals({ dataTerminalReady: false });  // DTR = false (GPIO0 high)
      await port.setSignals({ requestToSend: true  });      // RTS = true  (EN low)
      await new Promise(r => setTimeout(r, 100));
      await port.setSignals({ requestToSend: false });      // RTS = false (EN high)
      log("Issued RTS/DTR reset (normal boot).");
    } catch (e) {
      log("Reset sequence failed: " + e.message);
    }
  }

  connectBtn.onclick = async () => {
    try {
      // Ensure bundle is loaded
      if (!window.Transport || !window.ESPLoader) {
        throw new Error("esptool-js bundle not loaded (window.Transport / window.ESPLoader missing).");
      }

      // Request & open port
      port = await navigator.serial.requestPort({});
      await port.open({ baudRate: baud });
      log(`Port opened @ ${baud} baud.`);

      // 2) Use window.Transport / window.ESPLoader
      transport = new window.Transport(port);
      loader    = new window.ESPLoader(transport, baud, espTerminal);

      await loader.connect();
      const chip = await loader.chip;
      log(`Connected to chip: ${chip}`);

      flashBtn.disabled = false;
      resetBtn.disabled = false;
    } catch (e) {
      log("Connect failed: " + e.message);
    }
  };

  flashBtn.onclick = async () => {
    try {
      const url = "webflash/UTAudio.bin";
      log("Downloading " + url + " …");
      const resp = await fetch(url, { cache: "no-cache" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const buf = new Uint8Array(await resp.arrayBuffer());
      log(`Image size: ${buf.length} bytes`);

      log("Erasing…");
      await loader.eraseFlash();

      log("Writing flash @ 0x000000 …");
      await loader.writeFlash(0x000000, buf);

      log("Flash complete. Wrapping up…");
      await hardResetToApp();
      log("Done.");
    } catch (e) {
      log("Flash failed: " + e.message);
    }
  };

  resetBtn.onclick = async () => { await hardResetToApp(); };
})();
</script>
</body>
</html>
