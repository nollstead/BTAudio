
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTAudio Firmware Update</title>
  <style>
    :root{--bg:#121212;--panel:#1e1e1e;--text:#eaeaea;--muted:#bbb;--accent:#4CAF50;--accent2:#43a047;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:780px;margin:48px auto;padding:20px;background:var(--bg);color:var(--text);line-height:1.6}
    h1{margin:0 0 8px}.muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin:18px 0;box-shadow:0 0 20px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0;align-items:center}
    .fw-label-row {flex-basis: 100%; margin-bottom: 6px;}
    .instructions{background:#1e1e1e;border-radius:14px;padding:18px;margin-top:10px}
    button{background:var(--accent);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.55;cursor:not-allowed}
    button:hover:not([disabled]){background:var(--accent2)}
    textarea{width:100%;height:260px;border-radius:8px;border:1px solid var(--border);background:#0f0f0f;color:#cfe8ff;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    label{color:var(--muted)}

    /* Version picker styles */
    .fw-list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .fw-item{display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid var(--border);border-radius:10px;background:#141414}
    .fw-item input[type="radio"]{accent-color:#4CAF50;transform:scale(1.15);margin-top:2px}
    .fw-meta{display:flex;flex-direction:column;gap:2px}
    .fw-line{display:flex;gap:8px;flex-wrap:wrap}
    .fw-version{font-weight:700;color:#eaeaea}
    .fw-date{color:#ccc}
    .fw-label{color:#a6d5a6}
    .fw-notes{color:#bbb;font-size:0.95em}
  </style>
</head>
<body>
  <h1>BTAudio Firmware Update</h1>
  <p class="muted">v=1</p>

  <div class="panel">
    <div class="row">
      <button id="connectBtn" disabled>Connect</button>
      <button id="flashBtn"   disabled>Upload</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

<!-- Version picker (manifest-driven) -->
<div class="row" style="align-items:flex-start">
  <div class="fw-label-row">
    <label>Firmware Version</label>
  </div>

  <div id="fwList" class="fw-list">
    <div class="fw-item"><em class="muted">Loading versions…</em></div>
  </div>
</div>

    <div class="instructions">
      <h3>Instructions</h3>
      <ol>
        <li>Connect your BTAudio device to your computer via USB.</li>
        <li>Click <strong>Connect</strong> above and when prompted select the serial port (e.g., “USB‑SERIAL”).</li>
        <li>Click <strong>Upload</strong> and wait for completion.</li>
        <li>Your device will restart automatically once the upload is complete</li>
      </ol>
    </div>
  </div>

  <div class="panel">
    <h3>Log</h3>
    <textarea id="log" readonly></textarea>
  </div>


<script type="module">
  /********************************************************************
   * BTAudio Firmware Update – minimal index (manifest + connect shell)
   ********************************************************************/

  // Use the same version as test.html for identical behavior
  import * as esptool from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';
  const { ESPLoader, Transport } = esptool;

  // ---------- Logging ----------
  const logEl = document.getElementById('log');
  function ts() { return new Date().toLocaleTimeString(); }
  function w(s){ logEl.value += `[${ts()}] ${s}\n`; logEl.scrollTop = logEl.scrollHeight; }
  const term = { clean(){}, writeLine(s){ if(s) w(`ESPLoader: ${s}`); }, write(s){ if(s) w(`ESPLoader: ${s}`); } };

  // ---------- DOM ----------
  const connectBtn = document.getElementById('connectBtn');
  const flashBtn   = document.getElementById('flashBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const fwList     = document.getElementById('fwList');

  // ---------- State & constants ----------
  let port=null, transport=null, loader=null, connected=false, stubReady=false;
  const OPEN_BAUD = 115200; // (FAST_BAUD not used yet; we’ll add when flashing is wired)
  const FILTERS = [
    { usbVendorId: 0x10c4 },                               // CP210x (LyraT)
    { usbVendorId: 0x1a86, usbProductId: 0x7523 },         // CH340C/G (SparkFun)
    { usbVendorId: 0x1a86, usbProductId: 0x5523 }          // CH340 alt PID (common on some clones)
  ];
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  // Enable Connect when ESPLoader is present (matches test.html behavior)
  connectBtn.disabled = !(Transport && ESPLoader);

  // ---------- Manifest-driven picker ----------
  let manifest=null, selectedBuild=null;

  function parseSemver(v) {
    const m = String(v||'').trim().match(/^(\d+)\.(\d+)\.(\d+)$/);
    return m ? {maj:+m[1], min:+m[2], pat:+m[3]} : {maj:0, min:0, pat:0};
  }
  function compareSemverDesc(a, b) {
    const aa = parseSemver(a), bb = parseSemver(b);
    if (aa.maj !== bb.maj) return bb.maj - aa.maj;
    if (aa.min !== bb.min) return bb.min - aa.min;
    return bb.pat - aa.pat;
  }

  function renderFwList(builds){
    fwList.innerHTML = '';
    builds.forEach((b, idx) => {
      const id = `fw_${idx}`;
      const item = document.createElement('div');
      item.className = 'fw-item';

      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'fwPick';
      radio.id = id;
      radio.value = b.version || '';
      radio.checked = (selectedBuild && selectedBuild.version === b.version) || (!selectedBuild && idx===0);
      radio.addEventListener('change', () => { selectedBuild = b; w(`UI: Selected build ${b.version} (${b.date||'no date'})`); });

      const meta = document.createElement('div');
      meta.className = 'fw-meta';

      const topLine = document.createElement('div');
      topLine.className = 'fw-line';
      const vSpan = document.createElement('span'); vSpan.className = 'fw-version'; vSpan.textContent = b.version || 'v?';
      topLine.appendChild(vSpan);
      if (b.date){
        const dSpan = document.createElement('span'); dSpan.className='fw-date'; dSpan.textContent = b.date;
        topLine.appendChild(dSpan);
      }
      if (b.label){
        const lSpan = document.createElement('span'); lSpan.className='fw-label'; lSpan.textContent = b.label;
        topLine.appendChild(lSpan);
      }

      meta.appendChild(topLine);

      if (b.notes){
        const n = document.createElement('div'); n.className='fw-notes'; n.textContent = b.notes;
        meta.appendChild(n);
      }

      item.appendChild(radio);
      item.appendChild(meta);
      fwList.appendChild(item);

      if (!selectedBuild && radio.checked) selectedBuild = b;
    });
  }

  async function loadManifest() {
    w('Manifest: fetching webflash/manifest.json …');
    const resp = await fetch('https://nollstead.github.io/BTAudio/webflash/manifest.json', { cache: 'no-cache' });
    w(`Manifest: HTTP status ${resp.status}`);
    if (!resp.ok) throw new Error(`manifest HTTP ${resp.status}`);
    const data = await resp.json();
    if (!Array.isArray(data.builds)) throw new Error('manifest: builds missing');
    data.builds.sort((a,b) => {
      const sv = compareSemverDesc(a.version||'0.0.0', b.version||'0.0.0');
      if (sv !== 0) return sv;
      return String(b.date||'').localeCompare(String(a.date||''));
    });
    manifest = data;
    selectedBuild = null;
    renderFwList(data.builds);
    w(`Manifest: loaded ${data.builds.length} build(s); newest = ${data.builds[0]?.version||'n/a'}`);

    // Keep Upload disabled until Connect succeeds
    flashBtn.disabled = true;
  }

  loadManifest().catch(e => {
    fwList.innerHTML = '';
    const fallback = {
      version: 'current',
      chipFamily: 'ESP32',
      parts: [{ path: 'webflash/BTAudio.bin', offset: 0 }]
    };
    selectedBuild = fallback;
    const div = document.createElement('div');
    div.className='fw-item';
    div.innerHTML = `<input type="radio" name="fwPick" checked style="margin-top:2px">
                     <div class="fw-meta">
                       <div class="fw-line">
                         <span class="fw-version">current</span>
                         <span class="fw-date">manifest unavailable</span>
                       </div>
                       <div class="fw-notes">Using default BTAudio.bin</div>
                     </div>`;
    fwList.appendChild(div);
    w(`Manifest: load failed (${e?.message||e}). Using fallback image.`);

    // Keep Upload disabled until Connect succeeds
    flashBtn.disabled = true;
  });
</script>
</body>
</html>
