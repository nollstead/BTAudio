# Mongoose Web Server

Embedded web server component based on [Mongoose](https://mongoose.ws/) by Cesanta. Provides HTTP, WebSocket, and OTA update support for the BTAudio project.

## Features

- HTTP/HTTPS web server
- WebSocket support for real-time communication
- Web UI with authentication
- OTA firmware updates
- File system access
- Optional MQTT, SNTP, mDNS support

## Configuration

Configuration is in `mongoose_glue.h`. Current settings:

| Feature | Status |
|---------|--------|
| HTTP | Enabled |
| HTTPS | Disabled |
| Web UI | Enabled |
| Web UI Login | Enabled |
| WebSocket | Enabled |
| MQTT | Disabled |
| SNTP | Disabled |
| mDNS | Disabled |
| WiFi (managed) | Disabled |
| Captive Portal | Disabled |
| Modbus | Disabled |

## Files

| File | Description |
|------|-------------|
| `mongoose.c` | Core Mongoose library |
| `mongoose.h` | Mongoose API header |
| `mongoose_glue.c` | ESP32 integration layer |
| `mongoose_glue.h` | Configuration and glue API |
| `mongoose_impl.c` | Application-specific handlers |
| `mongoose_fs.c` | File system integration |
| `mongoose_config.h` | Build configuration |

## API Reference

### Core Functions

| Function | Description |
|----------|-------------|
| `mongoose_init()` | Initialize Mongoose event manager |
| `mongoose_poll()` | Process network events (call from main loop or task) |

### Handler Registration

| Function | Description |
|----------|-------------|
| `mongoose_set_http_handlers(name, ...)` | Register HTTP handlers |
| `mongoose_add_ws_handler(ms, fn)` | Add WebSocket handler with interval |
| `mongoose_add_ws_reporter(ms, name)` | Add periodic WebSocket reporter |
| `mongoose_add_custom_handler(url, fn, read_lvl, write_lvl)` | Add custom URL handler |

### Authentication

| Function | Description |
|----------|-------------|
| `mongoose_set_auth_handler(fn)` | Set custom auth validator |
| `glue_authenticate(user, pass)` | Validate credentials |

### State Management

| Function | Description |
|----------|-------------|
| `glue_get_state(state)` | Get current device state |
| `glue_update_state()` | Trigger UI refresh |
| `glue_get_settings(settings)` | Get configuration settings |
| `glue_set_settings(settings)` | Update settings |

### OTA Updates

| Function | Description |
|----------|-------------|
| `glue_ota_begin_firmware_update(name, size)` | Start OTA |
| `glue_ota_write_firmware_update(ctx, buf, len)` | Write chunk |
| `glue_ota_end_firmware_update(ctx)` | Finalize OTA |

### System Actions

| Function | Description |
|----------|-------------|
| `glue_start_reboot(param)` | Initiate system reboot |
| `glue_start_reformat(param)` | Reformat storage |
| `glue_start_save_event(param)` | Save event log |

## Data Structures

### Device State

```c
struct state {
    int speed;
    int temperature;
    int humidity;
    int uptime;
    char version[20];
    bool online;
    bool lights;
    int level;
};
```

### Settings

```c
struct settings {
    char string_val[40];
    int log_level;
    double double_val;
    int int_val;
    bool bool_val;
};
```

### Network Settings

```c
struct network_settings {
    char ip_address[20];
    char gw_address[20];
    char netmask[20];
    bool dhcp;
};
```

### Security

```c
struct security {
    char admin_password[40];
    char user_password[40];
};
```

## Usage

### Basic Setup

```c
#include "mongoose_glue.h"

void app_main(void) {
    // ... other init ...

    mongoose_init();

    // Main loop or create task
    while (1) {
        mongoose_poll();
        vTaskDelay(pdMS_TO_TICKS(10));
    }
}
```

### Custom HTTP Handler

```c
static void my_handler(struct mg_connection *c, int ev, void *ev_data) {
    if (ev == MG_EV_HTTP_MSG) {
        struct mg_http_message *hm = ev_data;
        mg_http_reply(c, 200, "", "Hello World\n");
    }
}

// In init:
mongoose_add_custom_handler("/api/hello", my_handler, 0, 0);
```

### WebSocket Handler

```c
static void ws_handler(struct mg_connection *c) {
    mg_ws_send(c, "{\"status\":\"ok\"}", 15, WEBSOCKET_OP_TEXT);
}

// In init:
mongoose_add_ws_handler(1000, ws_handler);  // Every 1000ms
```

## Generated by Mongoose Wizard

This component was configured using [Mongoose Wizard](https://mongoose.ws/wizard/). The wizard generates the glue code and configuration based on selected features.

## TODO

- [ ] Customize state struct for BTAudio (volume, EQ, connection status)
- [ ] Implement audio control API endpoints
- [ ] Create web UI for volume/EQ control
- [ ] Add WebSocket push for real-time status updates
- [ ] Enable and test WiFi AP mode
- [ ] Consider mDNS for easier discovery

## References

- [Mongoose Documentation](https://mongoose.ws/documentation/)
- [Mongoose Wizard](https://mongoose.ws/wizard/)
- [Cesanta GitHub](https://github.com/cesanta/mongoose)
